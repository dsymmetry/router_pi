# RPi5 Secure Router - System Security Configuration
# /etc/sysctl.d/99-router-security.conf
#
# This file contains kernel security parameters for hardening the
# Raspberry Pi 5 secure router against various network attacks.

#===============================================================================
# IPv4 NETWORK SECURITY
#===============================================================================

# Enable IP forwarding (required for router functionality)
net.ipv4.ip_forward = 1

# Disable ICMP redirects (prevent routing table manipulation)
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0

# Disable source routing (prevent IP spoofing)
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0

# Enable reverse path filtering (prevent IP spoofing)
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# Log martian packets (impossible addresses)
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# Ignore ICMP ping requests to broadcast/multicast
net.ipv4.icmp_echo_ignore_broadcasts = 1

# Ignore bogus ICMP error responses
net.ipv4.icmp_ignore_bogus_error_responses = 1

# Enable TCP SYN cookies (SYN flood protection)
net.ipv4.tcp_syncookies = 1

# Increase SYN backlog for better DDoS resistance
net.ipv4.tcp_max_syn_backlog = 2048

# Reduce SYN-ACK retries (faster timeout for dead connections)
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_syn_retries = 5

# TCP keepalive settings for better connection management
net.ipv4.tcp_keepalive_time = 7200
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 5

# Reduce TIME_WAIT timeout
net.ipv4.tcp_fin_timeout = 30

# Enable TCP window scaling
net.ipv4.tcp_window_scaling = 1

# Enable TCP timestamps
net.ipv4.tcp_timestamps = 1

#===============================================================================
# IPv6 SECURITY (DISABLED FOR SECURITY)
#===============================================================================

# Completely disable IPv6 to reduce attack surface
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1

#===============================================================================
# KERNEL SECURITY
#===============================================================================

# Restrict access to kernel logs
kernel.dmesg_restrict = 1

# Hide kernel pointers in /proc (prevent KASLR bypass)
kernel.kptr_restrict = 2

# Enable Yama ptrace restrictions
kernel.yama.ptrace_scope = 1

# Disable core dumps for security
kernel.core_pattern = |/bin/false

# Restrict kernel log buffer access
kernel.printk = 3 3 3 3

#===============================================================================
# FILESYSTEM SECURITY
#===============================================================================

# Prevent symlink/hardlink attacks
fs.protected_symlinks = 1
fs.protected_hardlinks = 1

# Prevent FIFO attacks in sticky directories
fs.protected_fifos = 2

# Prevent regular file attacks in sticky directories  
fs.protected_regular = 2

#===============================================================================
# MEMORY MANAGEMENT
#===============================================================================

# Randomize virtual address space (ASLR)
kernel.randomize_va_space = 2

# Prevent memory overcommit attacks
vm.overcommit_memory = 2
vm.overcommit_ratio = 80

# Reduce swappiness (keep more in RAM for performance)
vm.swappiness = 10

# Improve dirty page handling
vm.dirty_ratio = 15
vm.dirty_background_ratio = 5

#===============================================================================
# NETWORK BUFFER TUNING
#===============================================================================

# Increase network buffer sizes for better performance
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144
net.core.wmem_max = 16777216

# Increase netdev budget for packet processing
net.core.netdev_budget = 600

# Increase maximum number of packets in queue
net.core.netdev_max_backlog = 5000

#===============================================================================
# SECURITY MODULES
#===============================================================================

# Enable strict devtmpfs mounting
kernel.unprivileged_userns_clone = 0

# Restrict BPF to privileged users only
kernel.unprivileged_bpf_disabled = 1

# Enable JIT hardening
net.core.bpf_jit_harden = 2

#===============================================================================
# ADDITIONAL HARDENING
#===============================================================================

# Restrict perf events to root
kernel.perf_event_paranoid = 3

# Disable kexec (prevents certain rootkit attacks)
kernel.kexec_load_disabled = 1

# Enable strict IOMMU 
# (uncomment if your hardware supports it)
# iommu.strict = 1
