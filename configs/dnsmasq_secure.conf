# Secure DNS/DHCP Configuration for RPi5 Router
# Optimized for security and performance

#===============================================================================
# INTERFACE BINDING
#===============================================================================
# Only bind to the specified interface
interface=INTERFACE_PLACEHOLDER
bind-interfaces

# Listen only on the AP interface
listen-address=LISTEN_ADDRESS_PLACEHOLDER

# Don't bind to wildcard address
bind-dynamic

#===============================================================================
# DHCP CONFIGURATION
#===============================================================================
# DHCP range and lease time
dhcp-range=DHCP_RANGE_PLACEHOLDER

# DHCP options
dhcp-option=option:router,ROUTER_IP_PLACEHOLDER
dhcp-option=option:dns-server,ROUTER_IP_PLACEHOLDER
dhcp-option=option:netmask,255.255.255.0
dhcp-option=option:broadcast,BROADCAST_PLACEHOLDER
dhcp-option=option:domain-name,local
dhcp-option=option:ntp-server,ROUTER_IP_PLACEHOLDER

# MTU optimization for travel networks
dhcp-option=option:mtu,1500

# Faster DHCP lease renewal
dhcp-option=option:lease-time,43200

# PXE boot prevention (security)
dhcp-option=option:pxe-service

#===============================================================================
# DNS SECURITY CONFIGURATION
#===============================================================================
# Upstream DNS servers (secure, fast, privacy-focused)
server=1.1.1.1        # Cloudflare Primary
server=1.0.0.1        # Cloudflare Secondary
server=9.9.9.9        # Quad9 Primary (malware blocking)
server=8.8.8.8        # Google Primary (fallback)
server=8.8.4.4        # Google Secondary (fallback)

# Don't read /etc/resolv.conf
no-resolv

# Don't poll /etc/resolv.conf for changes
no-poll

# Cache size (increase for better performance)
cache-size=2000

# Negative cache TTL (cache failed lookups)
neg-ttl=3600

# Maximum TTL for cached entries
max-ttl=86400

# Minimum cache TTL
min-cache-ttl=60

#===============================================================================
# SECURITY FEATURES
#===============================================================================
# Don't forward queries for plain names (security)
domain-needed

# Don't forward reverse lookups for private IP ranges
bogus-priv

# Stop DNS rebinding attacks
stop-dns-rebind

# Allow localhost rebinding (needed for some applications)
rebind-localhost-ok

# Rebind domain exceptions (if needed)
# rebind-domain-ok=/in-addr.arpa/
# rebind-domain-ok=/ip6.arpa/

# Don't read /etc/hosts
no-hosts

# Additional hosts file for custom entries
# addn-hosts=/etc/dnsmasq.d/custom_hosts

#===============================================================================
# MALWARE AND AD BLOCKING
#===============================================================================
# Block common malware and tracking domains
address=/doubleclick.net/0.0.0.0
address=/googleadservices.com/0.0.0.0
address=/googlesyndication.com/0.0.0.0
address=/googletagmanager.com/0.0.0.0
address=/google-analytics.com/0.0.0.0
address=/facebook.com/0.0.0.0
address=/connect.facebook.net/0.0.0.0
address=/twitter.com/0.0.0.0
address=/ads.yahoo.com/0.0.0.0
address=/analytics.yahoo.com/0.0.0.0
address=/amazon-adsystem.com/0.0.0.0
address=/scorecardresearch.com/0.0.0.0
address=/outbrain.com/0.0.0.0
address=/taboola.com/0.0.0.0

# Block known malware domains
address=/malware.com/0.0.0.0
address=/badware.org/0.0.0.0
address=/phishing-site.net/0.0.0.0

# Block cryptocurrency mining
address=/coinhive.com/0.0.0.0
address=/coinerra.com/0.0.0.0
address=/minergate.com/0.0.0.0

# Additional blocklist (uncomment to use external lists)
# conf-file=/etc/dnsmasq.d/blocklist.conf

#===============================================================================
# PRIVACY ENHANCEMENTS
#===============================================================================
# Don't forward queries without domain part
localise-queries

# Return answers to DNS queries from /etc/hosts and --address, --server
# and --mx-host options before forwarding to upstream
dns-forward-max=1000

# Set the DNS packet size
edns-packet-max=1232

# Enable DNS over HTTPS (DoH) forwarding if supported
# proxy-dnssec

#===============================================================================
# PERFORMANCE OPTIMIZATION
#===============================================================================
# Read queries from all interfaces but reply only to the requesting interface
# local-service

# Enable parallel queries to all servers
all-servers

# Strict order - don't use if all-servers is enabled
# strict-order

# Faster startup
# no-daemon  # Commented out - causes issues with systemd/background operation

# Optimize for small networks
dns-loop-detect

# Expand simple names
expand-hosts

# Local domain
domain=local

#===============================================================================
# LOGGING CONFIGURATION
#===============================================================================
# Enable query logging (comment out for production)
log-queries

# Enable DHCP logging
log-dhcp

# Log to specific file
# log-facility=/var/log/dnsmasq.log

# Async logging for performance
log-async=20

#===============================================================================
# DHCP RESERVATIONS
#===============================================================================
# Static DHCP assignments (examples)
# dhcp-host=aa:bb:cc:dd:ee:ff,10.5.5.100,laptop
# dhcp-host=11:22:33:44:55:66,10.5.5.101,phone
# dhcp-host=99:88:77:66:55:44,10.5.5.102,tablet

#===============================================================================
# CAPTIVE PORTAL SUPPORT (Optional)
#===============================================================================
# Redirect all HTTP requests to captive portal
# address=/#/ROUTER_IP_PLACEHOLDER

# Captive portal exceptions
# server=/connectivitycheck.gstatic.com/8.8.8.8
# server=/clients3.google.com/8.8.8.8
# server=/captive.apple.com/8.8.8.8

#===============================================================================
# IPv6 CONFIGURATION (Disabled for security)
#===============================================================================
# Disable IPv6 support
filter-AAAA

# Don't provide IPv6 addresses
dhcp-range=::,static

#===============================================================================
# ADVANCED SECURITY OPTIONS
#===============================================================================
# Limit DNS query rate per IP (anti-DDoS)
# dns-rr-limit=100/10

# Set source address for upstream queries
# query-port=0

# Local reverse DNS
# local=/8.168.192.in-addr.arpa/

# Interface-specific options
# dhcp-option=tag:interface_tag,option:router,ROUTER_IP_PLACEHOLDER

#===============================================================================
# MONITORING AND DIAGNOSTICS
#===============================================================================
# Enable built-in TFTP server (disabled for security)
# enable-tftp
# tftp-root=/var/lib/tftpboot

# Enable built-in web server for diagnostics (disabled for security)
# enable-dbus

# Connection tracking
# conntrack

#===============================================================================
# CUSTOM CONFIGURATION
#===============================================================================
# Include additional configuration files
# conf-dir=/etc/dnsmasq.d/,*.conf

# User-defined options file
# conf-file=/etc/dnsmasq.d/custom.conf

